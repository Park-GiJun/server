<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½˜ì„œíŠ¸ ì˜ˆì•½ ëŒ€ê¸°ì—´ (ìˆ˜ì •ëœ ë²„ì „)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .auto-connections {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .connection-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .connection-card.connected {
            border-color: #17a2b8;
            background: rgba(23, 162, 184, 0.2);
        }

        .connection-card.waiting {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
        }

        .connection-card.active {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.3);
            animation: pulse 2s infinite;
        }

        .connection-card.expired {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
        }

        .connection-card.error {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .position-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            font-size: 1.2em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .manual-connection {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .message {
            font-size: 0.9em;
            margin: 10px 0;
            text-align: center;
        }

        .connection-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            margin: 5px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 5px;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .step-info {
            background: rgba(0, 123, 255, 0.2);
            border: 1px solid rgba(0, 123, 255, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .error-info {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .success-info {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align: center; margin-bottom: 30px;">ğŸµ ì½˜ì„œíŠ¸ ì˜ˆì•½ ëŒ€ê¸°ì—´ (ì—°ê²° ë¬¸ì œ í•´ê²°ëœ ë²„ì „)</h1>

    <div class="step-info">
        <strong>ğŸ”§ ìˆ˜ì •ì‚¬í•­:</strong><br>
        1. í† í° ìƒì„± í›„ ì—°ê²° ì§€ì—° ì¶”ê°€ (1ì´ˆ ëŒ€ê¸°)<br>
        2. ì—°ê²° ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€<br>
        3. ìƒì„¸í•œ ì˜¤ë¥˜ ë¡œê·¸ ë° ìƒíƒœ í‘œì‹œ<br>
        4. WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
    </div>

    <!-- í†µê³„ ì •ë³´ -->
    <div class="stats">
        <div class="stat-card">
            <div>ì´ ì—°ê²°</div>
            <div class="stat-number" id="totalConnections">0</div>
        </div>
        <div class="stat-card">
            <div>ì—°ê²° ì„±ê³µ</div>
            <div class="stat-number" id="connectedCount">0</div>
        </div>
        <div class="stat-card">
            <div>ì—°ê²° ì‹¤íŒ¨</div>
            <div class="stat-number" id="failedCount">0</div>
        </div>
        <div class="stat-card">
            <div>ì¬ì‹œë„ ì¤‘</div>
            <div class="stat-number" id="retryingCount">0</div>
        </div>
    </div>

    <!-- ìë™ ì—°ê²° (1~5ë²ˆ) -->
    <div class="auto-connections">
        <h3>ğŸ¤– ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ (1~5ë²ˆ)</h3>
        <div class="controls">
            <button class="btn" onclick="createAutoConnections()">ìë™ ì—°ê²° ìƒì„± (ê°œì„ ëœ ë¡œì§)</button>
            <button class="btn" onclick="disconnectAllAuto()">ëª¨ë“  ìë™ ì—°ê²° í•´ì œ</button>
            <button class="btn" onclick="retryFailedConnections()">ì‹¤íŒ¨í•œ ì—°ê²° ì¬ì‹œë„</button>
        </div>
        <div class="connection-grid" id="autoConnectionGrid">
            <!-- ìë™ ì—°ê²°ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ìˆ˜ë™ ì—°ê²° -->
    <div class="manual-connection">
        <h3>ğŸ‘¤ ìˆ˜ë™ ì—°ê²° í…ŒìŠ¤íŠ¸</h3>
        <div class="controls">
            <div class="input-group">
                <input type="text" id="manualUserId" placeholder="ì‚¬ìš©ì ID" value="manual-user">
                <input type="number" id="concertId" placeholder="ì½˜ì„œíŠ¸ ID" value="1">
            </div>
            <button class="btn" onclick="connectManual()">ìˆ˜ë™ ì—°ê²° (ê°œì„ ëœ ë¡œì§)</button>
            <button class="btn" onclick="disconnectManual()">ìˆ˜ë™ ì—°ê²° í•´ì œ</button>
            <button class="btn" onclick="sendStatusRequest()">ìƒíƒœ ì¡°íšŒ ìš”ì²­</button>
        </div>

        <div id="manualStatus" style="display: none;">
            <div class="position-circle" id="manualPosition">-</div>
            <div class="message" id="manualMessage">ì—°ê²° ì¤‘...</div>
        </div>
    </div>

    <div class="connection-info">
        <div><strong>ì—°ê²° ìƒíƒœ:</strong> <span id="connectionStatus">ì—°ê²° ì•ˆë¨</span></div>
        <div><strong>í† í° ID:</strong> <span id="currentTokenId">-</span></div>
        <div><strong>ë§ˆì§€ë§‰ ë©”ì‹œì§€:</strong> <span id="lastMessage">-</span></div>
        <div><strong>ì—°ê²° URL:</strong> <span id="wsUrl">-</span></div>
    </div>

    <div id="messageLog" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-top: 20px;">
        <h3>ìƒì„¸ ë¡œê·¸</h3>
        <div id="logContent"></div>
    </div>
</div>

<script>
    let autoConnections = {}; // ìë™ ì—°ê²°ë“¤ ì €ì¥
    let manualWebsocket = null; // ìˆ˜ë™ ì—°ê²°
    let manualTokenId = null; // ìˆ˜ë™ ì—°ê²° í† í°
    let nextUserId = 1; // ë‹¤ìŒ ì‚¬ìš©ì ID
    let retryAttempts = {}; // ì¬ì‹œë„ íšŸìˆ˜ ì¶”ì 

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
    window.addEventListener('load', function() {
        addLogMessage('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. ì—°ê²° í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.', 'info');
    });

    async function createAutoConnections() {
        addLogMessage('ğŸš€ ê°œì„ ëœ ìë™ ì—°ê²° ë¡œì§ ì‹œì‘', 'info');

        // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
        disconnectAllAuto();

        for (let i = 1; i <= 10; i++) {
            setTimeout(() => {
                createAutoConnectionWithRetry(i);
            }, i * 1000); // 1ì´ˆì”© ê°„ê²©ì„ ë‘ì–´ ìˆœì°¨ ìƒì„±
        }
    }

    async function createAutoConnectionWithRetry(userId, attempt = 1) {
        const maxRetries = 3;
        const userIdStr = `user-${userId}`;
        const concertId = 1;

        try {
            updateConnectionCard(userId, 'connecting', `ì—°ê²° ì‹œë„ ${attempt}íšŒì°¨`, '-');
            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: ${attempt}íšŒì°¨ ì‹œë„ ì‹œì‘`, 'info');

            // 1ë‹¨ê³„: í† í° ìƒì„±
            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: í† í° ìƒì„± API í˜¸ì¶œ`, 'info');

            const tokenResponse = await fetch(`http://localhost:8080/queue/token/${concertId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userIdStr
                })
            });

            if (!tokenResponse.ok) {
                throw new Error(`í† í° ìƒì„± HTTP ì˜¤ë¥˜: ${tokenResponse.status} - ${tokenResponse.statusText}`);
            }

            const tokenData = await tokenResponse.json();
            let tokenId;

            // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•íƒœ ì²˜ë¦¬
            if (tokenData?.data?.tokenId) {
                tokenId = tokenData.data.tokenId;
            } else if (tokenData?.data && typeof tokenData.data === 'string') {
                tokenId = tokenData.data;
            } else if (typeof tokenData === 'string') {
                tokenId = tokenData;
            } else {
                throw new Error(`í† í° ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: ${JSON.stringify(tokenData)}`);
            }

            if (!tokenId || typeof tokenId !== 'string') {
                throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ID: ${tokenId} (íƒ€ì…: ${typeof tokenId})`);
            }

            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: í† í° ìƒì„± ì„±ê³µ - ${tokenId}`, 'success');
            updateConnectionCard(userId, 'token-created', 'í† í° ìƒì„± ì™„ë£Œ', '-');

            // 2ë‹¨ê³„: WebSocket ì—°ê²° (1ì´ˆ ëŒ€ê¸° í›„)
            await new Promise(resolve => setTimeout(resolve, 1000));

            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì—°ê²° ì‹œë„`, 'info');
            updateConnectionCard(userId, 'connecting', 'WebSocket ì—°ê²° ì¤‘', '-');

            const wsUrl = `ws://localhost:8080/ws/queue?tokenId=${encodeURIComponent(tokenId)}&userId=${encodeURIComponent(userIdStr)}&concertId=${concertId}`;
            const websocket = new WebSocket(wsUrl);

            // ì—°ê²° íƒ€ì„ì•„ì›ƒ ì„¤ì •
            const connectionTimeout = setTimeout(() => {
                if (websocket.readyState === WebSocket.CONNECTING) {
                    websocket.close();
                    throw new Error('WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ (10ì´ˆ)');
                }
            }, 10000);

            websocket.onopen = function(event) {
                clearTimeout(connectionTimeout);
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì—°ê²° ì„±ê³µ!`, 'success');
                updateConnectionCard(userId, 'connected', 'ì—°ê²°ë¨', '-');
                retryAttempts[userId] = 0; // ì„±ê³µ ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ë¦¬ì…‹
                updateStats();
            };

            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ ë©”ì‹œì§€: ${data.message} (ìƒíƒœ: ${data.status}, ìˆœì„œ: ${data.position})`, 'info');

                    const statusClass = data.status?.toLowerCase() || 'unknown';
                    updateConnectionCard(userId, statusClass, data.message || 'ë©”ì‹œì§€ ì—†ìŒ', data.position || '-');
                    updateStats();
                } catch (e) {
                    addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜ - ${event.data}`, 'error');
                }
            };

            websocket.onclose = function(event) {
                clearTimeout(connectionTimeout);
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì¢…ë£Œ (ì½”ë“œ: ${event.code}, ì´ìœ : ${event.reason})`, 'warning');
                updateConnectionCard(userId, 'expired', `ì—°ê²° ì¢…ë£Œ (${event.code})`, '-');
                updateStats();
            };

            websocket.onerror = function(error) {
                clearTimeout(connectionTimeout);
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì˜¤ë¥˜`, 'error');
                console.error('WebSocket ì˜¤ë¥˜ ìƒì„¸:', error);
                updateConnectionCard(userId, 'error', 'WebSocket ì˜¤ë¥˜', '-');
                updateStats();
            };

            autoConnections[userId] = {
                websocket: websocket,
                tokenId: tokenId,
                userId: userIdStr,
                concertId: concertId
            };

        } catch (error) {
            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ ${attempt}íšŒì°¨ ì‹¤íŒ¨: ${error.message}`, 'error');
            console.error(`ìë™ ì—°ê²° ${userId}ë²ˆ ì‹¤íŒ¨ ìƒì„¸:`, error);

            if (attempt < maxRetries) {
                retryAttempts[userId] = attempt;
                updateConnectionCard(userId, 'error', `ì¬ì‹œë„ ${attempt}/${maxRetries}`, '-');
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: 3ì´ˆ í›„ ${attempt + 1}íšŒì°¨ ì¬ì‹œë„`, 'warning');

                setTimeout(() => {
                    createAutoConnectionWithRetry(userId, attempt + 1);
                }, 3000);
            } else {
                retryAttempts[userId] = maxRetries;
                updateConnectionCard(userId, 'error', 'ìµœì¢… ì‹¤íŒ¨', '-');
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼, ìµœì¢… ì‹¤íŒ¨`, 'error');
            }
            updateStats();
        }
    }

    function createConnectionCard(userId, type) {
        const grid = document.getElementById('autoConnectionGrid');
        const existingCard = document.getElementById(`connection-${userId}`);

        if (existingCard) {
            existingCard.remove();
        }

        const card = document.createElement('div');
        card.className = 'connection-card';
        card.id = `connection-${userId}`;

        card.innerHTML = `
            <div style="text-align: center;">
                <strong>${type} ${userId}ë²ˆ</strong>
                <div class="position-circle" id="position-${userId}">-</div>
                <div class="message" id="message-${userId}">ì¤€ë¹„ ì¤‘...</div>
            </div>
        `;

        grid.appendChild(card);
    }

    function updateConnectionCard(userId, status, message, position) {
        // ì¹´ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!document.getElementById(`connection-${userId}`)) {
            createConnectionCard(userId, 'auto');
        }

        const card = document.getElementById(`connection-${userId}`);
        const positionElement = document.getElementById(`position-${userId}`);
        const messageElement = document.getElementById(`message-${userId}`);

        if (card) {
            card.className = `connection-card ${status}`;
        }

        if (positionElement) {
            if (position > 0) {
                positionElement.textContent = position;
            } else if (status === 'active') {
                positionElement.innerHTML = 'âœ“';
            } else if (status === 'error') {
                positionElement.innerHTML = 'âœ—';
            } else if (status === 'connecting') {
                positionElement.innerHTML = 'â³';
            } else {
                positionElement.textContent = '-';
            }
        }

        if (messageElement) {
            messageElement.textContent = message || 'ìƒíƒœ ì—…ë°ì´íŠ¸';
        }
    }

    async function connectManual() {
        if (manualWebsocket && manualWebsocket.readyState === WebSocket.OPEN) {
            addLogMessage('ì´ë¯¸ ìˆ˜ë™ ì—°ê²°ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        let userId = document.getElementById('manualUserId').value;
        const concertId = document.getElementById('concertId').value;

        if (!userId) {
            userId = `manual-user-${nextUserId++}`;
            document.getElementById('manualUserId').value = userId;
        }

        if (!concertId) {
            addLogMessage('ì½˜ì„œíŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            updateConnectionStatus('í† í° ìƒì„± ì¤‘...', 'orange');
            addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): ê°œì„ ëœ ì—°ê²° ë¡œì§ ì‹œì‘`, 'info');

            // 1ë‹¨ê³„: í† í° ìƒì„±
            const tokenResponse = await fetch(`http://localhost:8080/queue/token/${concertId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId
                })
            });

            if (!tokenResponse.ok) {
                throw new Error(`í† í° ìƒì„± HTTP ì˜¤ë¥˜: ${tokenResponse.status} - ${tokenResponse.statusText}`);
            }

            const tokenData = await tokenResponse.json();
            let tokenId;

            if (tokenData?.data?.tokenId) {
                tokenId = tokenData.data.tokenId;
            } else if (tokenData?.data && typeof tokenData.data === 'string') {
                tokenId = tokenData.data;
            } else if (typeof tokenData === 'string') {
                tokenId = tokenData;
            } else {
                throw new Error(`í† í° ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: ${JSON.stringify(tokenData)}`);
            }

            if (!tokenId || typeof tokenId !== 'string') {
                throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ID: ${tokenId}`);
            }

            manualTokenId = tokenId;
            document.getElementById('currentTokenId').textContent = tokenId;
            addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): í† í° ìƒì„± ì„±ê³µ - ${tokenId}`, 'success');

            updateConnectionStatus('WebSocket ì—°ê²° ì¤‘... (1ì´ˆ ëŒ€ê¸°)', 'orange');

            // 2ë‹¨ê³„: 1ì´ˆ ëŒ€ê¸° í›„ WebSocket ì—°ê²°
            await new Promise(resolve => setTimeout(resolve, 1000));

            const wsUrl = `ws://localhost:8080/ws/queue?tokenId=${encodeURIComponent(tokenId)}&userId=${encodeURIComponent(userId)}&concertId=${concertId}`;
            document.getElementById('wsUrl').textContent = wsUrl;
            addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì—°ê²° ì‹œë„ - ${wsUrl}`, 'info');

            manualWebsocket = new WebSocket(wsUrl);

            // ì—°ê²° íƒ€ì„ì•„ì›ƒ
            const connectionTimeout = setTimeout(() => {
                if (manualWebsocket.readyState === WebSocket.CONNECTING) {
                    manualWebsocket.close();
                    throw new Error('WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ (10ì´ˆ)');
                }
            }, 10000);

            manualWebsocket.onopen = function(event) {
                clearTimeout(connectionTimeout);
                addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì—°ê²° ì„±ê³µ!`, 'success');
                updateConnectionStatus('ì—°ê²°ë¨', 'green');
                document.getElementById('manualStatus').style.display = 'block';

                // ì—°ê²° ì„±ê³µ í›„ ìƒíƒœ ì¡°íšŒ ìš”ì²­
                setTimeout(() => {
                    sendStatusRequest();
                }, 500);
            };

            manualWebsocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addLogMessage(`ìˆ˜ë™ ì—°ê²° ë©”ì‹œì§€: ${data.message} (ìƒíƒœ: ${data.status}, ìˆœì„œ: ${data.position})`, 'info');
                    updateManualStatus(data);
                    document.getElementById('lastMessage').textContent = data.message || 'ë©”ì‹œì§€ ì—†ìŒ';
                } catch (e) {
                    addLogMessage(`ìˆ˜ë™ ì—°ê²°: ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜ - ${event.data}`, 'error');
                }
            };

            manualWebsocket.onclose = function(event) {
                clearTimeout(connectionTimeout);
                addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì¢…ë£Œ (ì½”ë“œ: ${event.code}, ì´ìœ : ${event.reason})`, 'warning');
                updateConnectionStatus(`ì—°ê²° ì¢…ë£Œë¨ (${event.code})`, 'red');
                document.getElementById('manualStatus').style.display = 'none';
                manualWebsocket = null;
                manualTokenId = null;
            };

            manualWebsocket.onerror = function(error) {
                clearTimeout(connectionTimeout);
                addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì˜¤ë¥˜`, 'error');
                console.error('ìˆ˜ë™ WebSocket ì˜¤ë¥˜ ìƒì„¸:', error);
                updateConnectionStatus('ì—°ê²° ì˜¤ë¥˜', 'red');
                manualWebsocket = null;
                manualTokenId = null;
            };

        } catch (error) {
            addLogMessage(`ìˆ˜ë™ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            console.error('ìˆ˜ë™ ì—°ê²° ì‹¤íŒ¨ ìƒì„¸:', error);
            updateConnectionStatus('ì—°ê²° ì‹¤íŒ¨', 'red');
        }
    }

    function sendStatusRequest() {
        if (manualWebsocket && manualWebsocket.readyState === WebSocket.OPEN) {
            manualWebsocket.send('GET_STATUS');
            addLogMessage('ìƒíƒœ ì¡°íšŒ ìš”ì²­ ì „ì†¡', 'info');
        } else {
            addLogMessage('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
        }
    }

    function updateManualStatus(data) {
        const positionElement = document.getElementById('manualPosition');
        const messageElement = document.getElementById('manualMessage');

        if (positionElement) {
            if (data.position > 0) {
                positionElement.textContent = data.position;
            } else if (data.status === 'ACTIVE') {
                positionElement.innerHTML = 'âœ“';
            } else {
                positionElement.textContent = '-';
            }
        }

        if (messageElement) {
            messageElement.textContent = data.message || 'ìƒíƒœ ì—…ë°ì´íŠ¸';
        }
    }

    function disconnectManual() {
        if (manualWebsocket) {
            manualWebsocket.close();
            manualWebsocket = null;
            manualTokenId = null;
            updateConnectionStatus('ì—°ê²° í•´ì œë¨', 'gray');
            document.getElementById('manualStatus').style.display = 'none';
            document.getElementById('currentTokenId').textContent = '-';
            addLogMessage('ìˆ˜ë™ WebSocket ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.', 'info');
        }
    }

    function disconnectAllAuto() {
        Object.keys(autoConnections).forEach(userId => {
            const connection = autoConnections[userId];
            if (connection && connection.websocket) {
                connection.websocket.close();
                delete autoConnections[userId];
            }
        });

        document.getElementById('autoConnectionGrid').innerHTML = '';
        retryAttempts = {};
        addLogMessage('ëª¨ë“  ìë™ ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.', 'info');
        updateStats();
    }

    function retryFailedConnections() {
        const failedConnections = Object.keys(retryAttempts).filter(userId => retryAttempts[userId] > 0);

        if (failedConnections.length === 0) {
            addLogMessage('ì¬ì‹œë„í•  ì‹¤íŒ¨í•œ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
            return;
        }

        addLogMessage(`${failedConnections.length}ê°œì˜ ì‹¤íŒ¨í•œ ì—°ê²°ì„ ì¬ì‹œë„í•©ë‹ˆë‹¤.`, 'info');

        failedConnections.forEach((userId, index) => {
            setTimeout(() => {
                retryAttempts[userId] = 0; // ì¬ì‹œë„ ì¹´ìš´íŠ¸ ë¦¬ì…‹
                createAutoConnectionWithRetry(parseInt(userId));
            }, index * 1000);
        });
    }

    function updateConnectionStatus(status, color) {
        const statusElement = document.getElementById('connectionStatus');
        statusElement.textContent = status;
        statusElement.style.color = color;
    }

    function updateStats() {
        const cards = document.querySelectorAll('.connection-card');
        const total = cards.length;
        const connected = document.querySelectorAll('.connection-card.connected, .connection-card.waiting, .connection-card.active').length;
        const failed = document.querySelectorAll('.connection-card.error, .connection-card.expired').length;
        const retrying = Object.values(retryAttempts).filter(count => count > 0 && count < 3).length;

        document.getElementById('totalConnections').textContent = total;
        document.getElementById('connectedCount').textContent = connected;
        document.getElementById('failedCount').textContent = failed;
        document.getElementById('retryingCount').textContent = retrying;
    }

    function addLogMessage(message, type) {
        const logContent = document.getElementById('logContent');
        const timestamp = new Date().toLocaleTimeString();
        const colorMap = {
            'success': '#28a745',
            'info': '#17a2b8',
            'warning': '#ffc107',
            'error': '#dc3545'
        };

        const logEntry = document.createElement('div');
        logEntry.style.color = colorMap[type] || '#ffffff';
        logEntry.style.marginBottom = '5px';
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;

        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;

        // ë¡œê·¸ ê°œìˆ˜ ì œí•œ
        if (logContent.children.length > 100) {
            logContent.removeChild(logContent.firstChild);
        }
    }

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° ì •ë¦¬
    window.addEventListener('beforeunload', function() {
        Object.values(autoConnections).forEach(connection => {
            if (connection && connection.websocket) connection.websocket.close();
        });
        if (manualWebsocket) {
            manualWebsocket.close();
        }
    });
</script>
</body>
</html>