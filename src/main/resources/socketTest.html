<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½˜ì„œíŠ¸ ì˜ˆì•½ ëŒ€ê¸°ì—´</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .auto-connections {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .connection-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .connection-card.connected {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }

        .connection-card.waiting {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
        }

        .connection-card.active {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.3);
            animation: pulse 2s infinite;
        }

        .connection-card.expired {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
        }

        .connection-card.error {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.3);
        }

        .queue-status {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .waiting {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
        }

        .active {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid #28a745;
            animation: pulse 2s infinite;
        }

        .expired {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .position-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            font-size: 1.5em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .manual-connection {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .message {
            font-size: 1.0em;
            margin: 10px 0;
            text-align: center;
        }

        .connection-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            margin: 5px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 5px;
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .step-info {
            background: rgba(0, 123, 255, 0.2);
            border: 1px solid rgba(0, 123, 255, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align: center; margin-bottom: 30px;">ğŸµ ì½˜ì„œíŠ¸ ì˜ˆì•½ ëŒ€ê¸°ì—´ ì‹œë®¬ë ˆì´í„°</h1>

    <div class="step-info">
        <strong>ì˜¬ë°”ë¥¸ í”Œë¡œìš°:</strong> 1) í† í° ìƒì„± API í˜¸ì¶œ â†’ 2) ë°›ì€ í† í°ìœ¼ë¡œ WebSocket ì—°ê²°
    </div>

    <!-- í†µê³„ ì •ë³´ -->
    <div class="stats">
        <div class="stat-card">
            <div>ì´ ì—°ê²°</div>
            <div class="stat-number" id="totalConnections">0</div>
        </div>
        <div class="stat-card">
            <div>í™œì„± (ì˜ˆì•½ ê°€ëŠ¥)</div>
            <div class="stat-number" id="activeConnections">0</div>
        </div>
        <div class="stat-card">
            <div>ëŒ€ê¸° ì¤‘</div>
            <div class="stat-number" id="waitingConnections">0</div>
        </div>
        <div class="stat-card">
            <div>ì—ëŸ¬/ë§Œë£Œ</div>
            <div class="stat-number" id="errorConnections">0</div>
        </div>
    </div>

    <!-- ìë™ ì—°ê²° (1~10ë²ˆ) -->
    <div class="auto-connections">
        <h3>ğŸ¤– ìë™ ì—°ê²° (1~10ë²ˆ) - ì˜¬ë°”ë¥¸ í”Œë¡œìš°ë¡œ ìƒì„±</h3>
        <div class="controls">
            <button class="btn" onclick="createAutoConnections()">ìë™ ì—°ê²° ìƒì„± (í† í° ìƒì„± + WebSocket)</button>
            <button class="btn" onclick="disconnectAllAuto()">ëª¨ë“  ìë™ ì—°ê²° í•´ì œ</button>
        </div>
        <div class="connection-grid" id="autoConnectionGrid">
            <!-- ìë™ ì—°ê²°ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ìˆ˜ë™ ì—°ê²° (11ë²ˆë¶€í„°) -->
    <div class="manual-connection">
        <h3>ğŸ‘¤ ìˆ˜ë™ ì—°ê²° (11ë²ˆë¶€í„°)</h3>
        <div class="controls">
            <div class="input-group">
                <input type="text" id="manualUserId" placeholder="ì‚¬ìš©ì ID" value="">
                <input type="number" id="concertId" placeholder="ì½˜ì„œíŠ¸ ID" value="1">
            </div>
            <button class="btn" onclick="connectManual()">ìˆ˜ë™ ì—°ê²° (í† í° ìƒì„± + WebSocket)</button>
            <button class="btn" onclick="disconnectManual()">ìˆ˜ë™ ì—°ê²° í•´ì œ</button>
        </div>

        <div id="manualQueueStatus" class="queue-status" style="display: none;">
            <div class="position-circle" id="manualPositionCircle">-</div>
            <div class="message" id="manualStatusMessage">ì—°ê²° ì¤‘...</div>
            <div id="manualAdditionalInfo"></div>
        </div>
    </div>

    <div class="connection-info">
        <div><strong>ìˆ˜ë™ ì—°ê²° ìƒíƒœ:</strong> <span id="manualConnectionStatus">ì—°ê²° ì•ˆë¨</span></div>
        <div><strong>ìˆ˜ë™ í† í° ID:</strong> <span id="manualTokenId">-</span></div>
        <div><strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> <span id="lastUpdate">-</span></div>
        <div><strong>WebSocket URL:</strong> <span id="wsUrl">-</span></div>
    </div>

    <div id="messageLog" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-top: 20px;">
        <h3>ë©”ì‹œì§€ ë¡œê·¸</h3>
        <div id="logContent"></div>
    </div>
</div>

<script>
    let autoConnections = {}; // ìë™ ì—°ê²°ë“¤ ì €ì¥
    let manualWebsocket = null; // ìˆ˜ë™ ì—°ê²°
    let manualTokenId = null; // ìˆ˜ë™ ì—°ê²° í† í°
    let nextUserId = 11; // ë‹¤ìŒ ìˆ˜ë™ ì—°ê²° ì‚¬ìš©ì ID

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ 1~10ë²ˆ ì—°ê²° ìƒì„±
    window.addEventListener('load', function() {
        setTimeout(() => {
            createAutoConnections();
        }, 1000);
    });

    async function createAutoConnections() {
        addLogMessage('ìë™ ì—°ê²° ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤... (í† í° ìƒì„± â†’ WebSocket ì—°ê²°)', 'info');

        for (let i = 1; i <= 10; i++) {
            setTimeout(() => {
                createAutoConnection(i);
            }, i * 500); // 500ms ê°„ê²©ìœ¼ë¡œ ìˆœì°¨ ì—°ê²° (API í˜¸ì¶œ ì‹œê°„ ê³ ë ¤)
        }
    }

    async function createAutoConnection(userId) {
        const concertId = 1;
        const userIdStr = `user-${userId}`;

        try {
            // ì—°ê²° ì¹´ë“œ ìƒì„±
            createConnectionCard(userId, 'auto');
            updateConnectionCard(userId, 'connecting', 'í† í° ìƒì„± ì¤‘...', '-');

            // 1ë‹¨ê³„: í† í° ìƒì„± API í˜¸ì¶œ
            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: í† í° ìƒì„± API í˜¸ì¶œ ì¤‘...`, 'info');

            const tokenResponse = await fetch(`http://localhost:8080/queue/token/${concertId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userIdStr
                })
            });

            if (!tokenResponse.ok) {
                throw new Error(`í† í° ìƒì„± ì‹¤íŒ¨: ${tokenResponse.status}`);
            }

            const tokenData = await tokenResponse.json();

            // API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ í† í° ID ì¶”ì¶œ
            let tokenId;
            if (tokenData && tokenData.data && tokenData.data.tokenId) {
                tokenId = tokenData.data.tokenId;
            } else if (tokenData && tokenData.data && typeof tokenData.data === 'string') {
                tokenId = tokenData.data;
            } else if (typeof tokenData === 'string') {
                tokenId = tokenData;
            } else {
                console.log('í† í° ì‘ë‹µ ë°ì´í„°:', tokenData);
                throw new Error('í† í° ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
            }

            // tokenIdê°€ ë¬¸ìì—´ì¸ì§€ í™•ì¸
            if (typeof tokenId !== 'string') {
                console.log('í† í° ID íƒ€ì…:', typeof tokenId, 'ê°’:', tokenId);
                throw new Error(`í† í° IDê°€ ë¬¸ìì—´ì´ ì•„ë‹™ë‹ˆë‹¤: ${typeof tokenId}`);
            }

            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: í† í° ìƒì„± ì™„ë£Œ (${tokenId})`, 'success');
            updateConnectionCard(userId, 'token-created', 'WebSocket ì—°ê²° ì¤‘...', '-');

            // 2ë‹¨ê³„: WebSocket ì—°ê²°
            const wsUrl = `ws://localhost:8080/ws/queue?tokenId=${encodeURIComponent(tokenId)}&userId=${encodeURIComponent(userIdStr)}&concertId=${concertId}`;
            const websocket = new WebSocket(wsUrl);

            websocket.onopen = function(event) {
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì—°ê²° ì„±ê³µ`, 'success');
                updateConnectionCard(userId, 'connected', 'ì—°ê²°ë¨', '-');
                updateStats();
            };

            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: ${data.message}`, 'info');
                    updateConnectionCard(userId, data.status.toLowerCase(), data.message, data.position);
                    updateStats();
                } catch (e) {
                    console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            };

            websocket.onclose = function(event) {
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì¢…ë£Œ`, 'warning');
                updateConnectionCard(userId, 'expired', 'ì—°ê²° ì¢…ë£Œë¨', '-');
                updateStats();
            };

            websocket.onerror = function(error) {
                addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ: WebSocket ì˜¤ë¥˜`, 'error');
                updateConnectionCard(userId, 'error', 'ì—°ê²° ì˜¤ë¥˜', '-');
                updateStats();
            };

            autoConnections[userId] = {
                websocket: websocket,
                tokenId: tokenId
            };

        } catch (error) {
            console.error(`ìë™ ì—°ê²° ${userId}ë²ˆ ìƒì„± ì‹¤íŒ¨:`, error);
            addLogMessage(`ìë™ ì—°ê²° ${userId}ë²ˆ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            updateConnectionCard(userId, 'error', 'ìƒì„± ì‹¤íŒ¨', '-');
            updateStats();
        }
    }

    function createConnectionCard(userId, type) {
        const grid = document.getElementById('autoConnectionGrid');
        const card = document.createElement('div');
        card.className = 'connection-card';
        card.id = `connection-${userId}`;

        card.innerHTML = `
            <div style="text-align: center;">
                <strong>${type === 'auto' ? 'ìë™' : 'ìˆ˜ë™'} ${userId}ë²ˆ</strong>
                <div class="position-circle" id="position-${userId}">-</div>
                <div class="message" id="message-${userId}">ì¤€ë¹„ ì¤‘...</div>
            </div>
        `;

        grid.appendChild(card);
    }

    function updateConnectionCard(userId, status, message, position) {
        const card = document.getElementById(`connection-${userId}`);
        const positionElement = document.getElementById(`position-${userId}`);
        const messageElement = document.getElementById(`message-${userId}`);

        if (card) {
            card.className = `connection-card ${status}`;
        }

        if (positionElement) {
            if (position > 0) {
                positionElement.textContent = position;
            } else if (status === 'active') {
                positionElement.innerHTML = 'âœ“';
            } else {
                positionElement.textContent = '-';
            }
        }

        if (messageElement) {
            messageElement.textContent = message || 'ìƒíƒœ ì—…ë°ì´íŠ¸';
        }
    }

    async function connectManual() {
        if (manualWebsocket) {
            alert('ì´ë¯¸ ìˆ˜ë™ ì—°ê²°ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        let userId = document.getElementById('manualUserId').value;
        if (!userId) {
            userId = `user-${nextUserId}`;
            document.getElementById('manualUserId').value = userId;
            nextUserId++;
        }

        const concertId = document.getElementById('concertId').value;

        if (!concertId) {
            alert('ì½˜ì„œíŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            updateManualConnectionStatus('í† í° ìƒì„± ì¤‘...', 'orange');

            // 1ë‹¨ê³„: í† í° ìƒì„± API í˜¸ì¶œ
            addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): í† í° ìƒì„± API í˜¸ì¶œ ì¤‘...`, 'info');

            const tokenResponse = await fetch(`http://localhost:8080/queue/token/${concertId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId
                })
            });

            if (!tokenResponse.ok) {
                throw new Error(`í† í° ìƒì„± ì‹¤íŒ¨: ${tokenResponse.status}`);
            }

            const tokenData = await tokenResponse.json();

            // tokenDataê°€ ê°ì²´ì¸ì§€ í™•ì¸í•˜ê³  ì˜¬ë°”ë¥´ê²Œ ì¶”ì¶œ
            if (typeof tokenData === 'object' && tokenData.data) {
                manualTokenId = tokenData.data;
            } else if (typeof tokenData === 'string') {
                manualTokenId = tokenData;
            } else {
                throw new Error('í† í° ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
            }

            // tokenIdê°€ ë¬¸ìì—´ì¸ì§€ í™•ì¸
            if (typeof manualTokenId !== 'string') {
                throw new Error(`í† í° IDê°€ ë¬¸ìì—´ì´ ì•„ë‹™ë‹ˆë‹¤: ${typeof manualTokenId}`);
            }

            document.getElementById('manualTokenId').textContent = manualTokenId;
            addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): í† í° ìƒì„± ì™„ë£Œ (${manualTokenId})`, 'success');

            updateManualConnectionStatus('WebSocket ì—°ê²° ì¤‘...', 'orange');

            // 2ë‹¨ê³„: WebSocket ì—°ê²°
            const wsUrl = `ws://localhost:8080/ws/queue?tokenId=${encodeURIComponent(manualTokenId)}&userId=${encodeURIComponent(userId)}&concertId=${concertId}`;
            document.getElementById('wsUrl').textContent = wsUrl;

            manualWebsocket = new WebSocket(wsUrl);

            manualWebsocket.onopen = function(event) {
                addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì—°ê²° ì„±ê³µ`, 'success');
                updateManualConnectionStatus('ì—°ê²°ë¨', 'green');
                document.getElementById('manualQueueStatus').style.display = 'block';
            };

            manualWebsocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateManualQueueStatus(data);
                    addLogMessage(`ìˆ˜ë™ ì—°ê²° ë©”ì‹œì§€: ${data.message}`, 'info');
                } catch (e) {
                    console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
                    addLogMessage('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ' + event.data, 'error');
                }
            };

            manualWebsocket.onclose = function(event) {
                addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì¢…ë£Œ`, 'warning');
                updateManualConnectionStatus('ì—°ê²° ì¢…ë£Œë¨', 'red');
                document.getElementById('manualQueueStatus').style.display = 'none';
                manualWebsocket = null;
                manualTokenId = null;
            };

            manualWebsocket.onerror = function(error) {
                addLogMessage(`ìˆ˜ë™ ì—°ê²°(${userId}): WebSocket ì˜¤ë¥˜`, 'error');
                updateManualConnectionStatus('ì—°ê²° ì˜¤ë¥˜', 'red');
                manualWebsocket = null;
                manualTokenId = null;
            };

        } catch (error) {
            console.error('ìˆ˜ë™ ì—°ê²° ìƒì„± ì‹¤íŒ¨:', error);
            addLogMessage(`ìˆ˜ë™ ì—°ê²° ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            updateManualConnectionStatus('ìƒì„± ì‹¤íŒ¨', 'red');
        }
    }

    function disconnectManual() {
        if (manualWebsocket) {
            manualWebsocket.close();
            manualWebsocket = null;
            manualTokenId = null;
            updateManualConnectionStatus('ì—°ê²° í•´ì œë¨', 'gray');
            document.getElementById('manualQueueStatus').style.display = 'none';
            document.getElementById('manualTokenId').textContent = '-';
            addLogMessage('ìˆ˜ë™ WebSocket ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.', 'info');
        }
    }

    function disconnectAllAuto() {
        Object.keys(autoConnections).forEach(userId => {
            const connection = autoConnections[userId];
            if (connection && connection.websocket) {
                connection.websocket.close();
                delete autoConnections[userId];
            }
        });

        document.getElementById('autoConnectionGrid').innerHTML = '';
        addLogMessage('ëª¨ë“  ìë™ ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.', 'info');
        updateStats();
    }

    function updateManualQueueStatus(data) {
        const statusElement = document.getElementById('manualQueueStatus');
        const positionElement = document.getElementById('manualPositionCircle');
        const messageElement = document.getElementById('manualStatusMessage');
        const infoElement = document.getElementById('manualAdditionalInfo');

        if (data.position > 0) {
            positionElement.textContent = data.position;
        } else if (data.status === 'ACTIVE') {
            positionElement.innerHTML = 'âœ“';
        } else {
            positionElement.textContent = '-';
        }

        messageElement.textContent = data.message || 'ìƒíƒœ ì—…ë°ì´íŠ¸';

        infoElement.innerHTML = `
            <div>ìƒíƒœ: ${data.status}</div>
            <div>ì½˜ì„œíŠ¸ ID: ${data.concertId}</div>
            <div>í† í° ID: ${data.tokenId}</div>
        `;

        statusElement.className = 'queue-status';
        switch(data.status) {
            case 'WAITING':
                statusElement.classList.add('waiting');
                break;
            case 'ACTIVE':
                statusElement.classList.add('active');
                break;
            case 'EXPIRED':
                statusElement.classList.add('expired');
                break;
        }

        updateLastUpdate();
    }

    function updateManualConnectionStatus(status, color) {
        const statusElement = document.getElementById('manualConnectionStatus');
        statusElement.textContent = status;
        statusElement.style.color = color;
        updateLastUpdate();
    }

    function updateStats() {
        const cards = document.querySelectorAll('.connection-card');
        let total = cards.length;
        let active = document.querySelectorAll('.connection-card.active').length;
        let waiting = document.querySelectorAll('.connection-card.waiting').length;
        let expired = document.querySelectorAll('.connection-card.expired, .connection-card.error').length;

        document.getElementById('totalConnections').textContent = total;
        document.getElementById('activeConnections').textContent = active;
        document.getElementById('waitingConnections').textContent = waiting;
        document.getElementById('errorConnections').textContent = expired;
    }

    function updateLastUpdate() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    function addLogMessage(message, type) {
        const logContent = document.getElementById('logContent');
        const timestamp = new Date().toLocaleTimeString();
        const colorMap = {
            'success': '#28a745',
            'info': '#17a2b8',
            'warning': '#ffc107',
            'error': '#dc3545'
        };

        const logEntry = document.createElement('div');
        logEntry.style.color = colorMap[type] || '#ffffff';
        logEntry.style.marginBottom = '5px';
        logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;

        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;

        if (logContent.children.length > 100) {
            logContent.removeChild(logContent.firstChild);
        }
    }

    window.addEventListener('beforeunload', function() {
        Object.values(autoConnections).forEach(connection => {
            if (connection && connection.websocket) connection.websocket.close();
        });
        if (manualWebsocket) {
            manualWebsocket.close();
        }
    });
</script>
</body>
</html>